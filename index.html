<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—è –ö–æ–ª–ª–µ–∫—Ü–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            line-height: 1.6;
            padding: 20px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: #dc3545;
        }
        .stats-bar {
            background: rgba(45, 45, 68, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 14px;
            font-weight: bold;
            justify-content: space-between;
            align-items: center;
        }
        .stats-left {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .total-time {
            background: rgba(139, 92, 246, 0.3);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: rgba(45, 45, 68, 0.8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header-title h1 {
            font-size: 2rem;
            color: #4fc3f7;
        }
        .header-title p {
            color: #a0a0c0;
            font-size: 1rem;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .action-btn {
            background: #2980b9;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .action-btn:hover {
            background: #2573a7;
        }
        .action-btn.export {
            background: #28a745;
        }
        .action-btn.export:hover {
            background: #218838;
        }
        .action-btn.danger {
            background: #dc3545;
        }
        .action-btn.danger:hover {
            background: #c82333;
        }
        .add-btn {
            background: #2980b9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .add-btn:hover {
            background: #2573a7;
        }
        .tabs-container {
            background: rgba(45, 45, 68, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .view-tab {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            background: #3a3a5a;
            font-size: 14px;
        }
        .view-tab.active {
            background: #2980b9;
            color: white;
        }
        .view-tab:not(.active):hover {
            background: #4a4a6a;
        }
        .search-container {
            background: rgba(45, 45, 68, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 25px;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            font-size: 1rem;
            background: #3a3a5a;
            color: #e6e6e6;
        }
        .sort-select {
            padding: 12px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            font-size: 0.95rem;
            background: #3a3a5a;
            color: #e6e6e6;
            min-width: 150px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            background: #3a3a5a;
            font-size: 14px;
        }
        .tab.active {
            background: #2980b9;
            color: white;
        }
        .tab:not(.active):hover {
            background: #4a4a6a;
        }
        .filters-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-filter, .year-filter, .letter-filter, .genre-filter {
            padding: 10px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            font-size: 0.95rem;
            background: #3a3a5a;
            color: #e6e6e6;
            min-width: 120px;
        }
        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .collection-item {
            background: rgba(45, 45, 68, 0.8);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }
        .collection-item.collapsed-hidden {
            display: none;
        }
        .series-highlight {
            border: 3px solid #66bb6a;
            background: rgba(50, 80, 50, 0.3);
        }
        .action-btns {
            position: absolute;
            top: 10px;
            left: 10px;
            display: none;
            z-index: 10;
            display: flex;
            gap: 5px;
        }
        .edit-btn, .delete-btn, .add-episode-btn {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-btn {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }
        .add-episode-btn {
            background: rgba(46, 204, 113, 0.8);
            color: white;
            width: 32px;
            height: 32px;
            font-size: 18px;
        }
        .collection-item:hover .action-btns {
            display: flex;
        }
        .collection-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }
        .item-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .item-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            margin-top: 8px;
        }
        .status-completed,
        .status-watched,
        .status-completed_audio {
            background: #28a745;
            color: white;
        }
        .status-listening,
        .status-reading,
        .status-playing {
            background: #17a2b8;
            color: white;
        }
        .status-online {
            background: #6f42c1 !important;
            color: white !important;
        }
        .status-youtube {
            background: #ff6b6b !important;
            color: white !important;
        }
        .status-watching {
            background: #6f42c1;
            color: white;
        }
        .item-content {
            padding: 15px;
        }
        .item-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-series-btn {
            background: rgba(100, 100, 255, 0.3);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 6px;
        }
        .toggle-series-btn:hover {
            background: rgba(100, 100, 255, 0.6);
        }
        .item-year {
            color: #a0a0c0;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .item-time {
            color: #ba68c8;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .item-series-info {
            color: #66bb6a;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: bold;
            background: rgba(102, 187, 106, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }
        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tag {
            background: #3a3a5a;
            color: #e6e6e6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .tag.fantasy { background: rgba(52, 152, 219, 0.3); }
        .tag.scifi { background: rgba(155, 89, 182, 0.3); }
        .tag.drama { background: rgba(231, 76, 60, 0.3); }
        .tag.comedy { background: rgba(241, 196, 15, 0.3); color: #333; }
        .tag.horror { background: rgba(230, 126, 34, 0.3); }
        .tag.romance { background: rgba(232, 65, 122, 0.3); }
        .tag.adventure { background: rgba(46, 204, 113, 0.3); }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #a0a0c0;
        }
        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }
        .table-view {
            display: none;
        }
        .table-view.active {
            display: block;
        }
        .collection-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(45, 45, 68, 0.8);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .collection-table th {
            background: #3a3a5a;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #4a4a6a;
        }
        .collection-table td {
            padding: 12px;
            border-bottom: 1px solid #4a4a6a;
        }
        .collection-table tr:last-child td {
            border-bottom: none;
        }
        .collection-table tr:nth-child(even) {
            background: rgba(60, 60, 80, 0.3);
        }
        .collection-table tr:hover {
            background: rgba(100, 100, 150, 0.2);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #2d2d44;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            padding: 25px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #4fc3f7;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e6e6e6;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #4a4a6a;
            border-radius: 6px;
            font-size: 1rem;
            background: #3a3a5a;
            color: #e6e6e6;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-cancel {
            background: #3a3a5a;
            color: #e6e6e6;
        }
        .btn-cancel:hover {
            background: #4a4a6a;
        }
        .btn-add, .btn-save {
            background: #2980b9;
            color: white;
        }
        .btn-add:hover, .btn-save:hover {
            background: #2573a7;
        }
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .image-modal.active {
            display: flex;
        }
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close-image {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .achievement {
            background: rgba(45, 45, 68, 0.8);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .ach-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ach-icon.bronze { background: linear-gradient(135deg, #cd7f32, #d28a45); }
        .ach-icon.silver { background: linear-gradient(135deg, #c0c0c0, #d3d3d3); }
        .ach-icon.gold { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .ach-content h3 {
            margin: 0 0 6px 0;
            color: #4fc3f7;
            font-size: 1.1rem;
        }
        .ach-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #a0a0c0;
        }
        .franchise-section {
            background: rgba(60, 60, 90, 0.7);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .franchise-section h3 {
            margin-bottom: 12px;
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .franchise-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .franchise-item {
            background: rgba(45, 45, 68, 0.8);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .franchise-item:hover {
            background: rgba(70, 70, 100, 0.9);
        }
        .franchise-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .franchise-meta {
            color: #a0a0c0;
            font-size: 0.85rem;
        }
        @media (max-width: 768px) {
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .stats-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .total-time {
                align-self: flex-end;
            }
            .search-box {
                flex-direction: column;
            }
            .filters-row {
                flex-direction: column;
            }
            .collection-table {
                font-size: 0.8rem;
            }
            .collection-table th,
            .collection-table td {
                padding: 8px;
            }
        }
        .tag-pill.selected {
            background: #4fc3f7 !important;
            color: #1a1a2e !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="notification" id="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
        <div class="stats-bar" id="statsBar">
            <div class="stats-left" id="statsLeft"></div>
            <div class="total-time" id="totalTime">–û–±—â–µ–µ –≤—Ä–µ–º—è: 0—á 0–º–∏–Ω</div>
        </div>
        <header>
            <div class="header-title">
                <h1>–ú–æ—è –ö–æ–ª–ª–µ–∫—Ü–∏—è</h1>
                <p>–ò–≥—Ä—ã ‚Ä¢ –§–∏–ª—å–º—ã ‚Ä¢ –ê–Ω–∏–º–µ ‚Ä¢ –°–µ—Ä–∏–∞–ª—ã ‚Ä¢ –ê—É–¥–∏–æ–∫–Ω–∏–≥–∏ ‚Ä¢ –†–∞—Å—Å–∫–∞–∑—ã</p>
            </div>
            <div class="header-actions">
                <button class="add-btn" onclick="openModal()"><i>‚ûï</i> –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="action-btn export" onclick="exportCollection()"><i>üì§</i> –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="action-btn" onclick="document.getElementById('importInput').click()"><i>üì•</i> –ò–º–ø–æ—Ä—Ç JSON</button>
                <button class="action-btn" onclick="document.getElementById('csvImportInput').click()"><i>üìä</i> –ò–º–ø–æ—Ä—Ç CSV</button>
                <button class="action-btn danger" onclick="clearAll()"><i>üóëÔ∏è</i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <button class="action-btn" onclick="undoLastAction()"><i>‚Ü©Ô∏è</i> –û—Ç–º–µ–Ω–∏—Ç—å</button>
                <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importCollection(event)">
                <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="importCSVCollection(event)">
            </div>
        </header>
        <div class="tabs-container">
            <div class="view-tab active" onclick="switchView('grid')">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
            <div class="view-tab" onclick="switchView('table')">–¢–∞–±–ª–∏—Ü–∞</div>
        </div>
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É, —Å–µ—Ä–∏–∏..." oninput="filterCollections()">
                <select class="sort-select" id="sortSelect" onchange="filterCollections()">
                    <option value="date_desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="date_asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                    <option value="title_asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ê-–Ø</option>
                    <option value="title_desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –Ø-–ê</option>
                    <option value="popular">–°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                </select>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('all')">–í—Å–µ</div>
                <div class="tab" onclick="switchTab('game')">–ò–≥—Ä—ã</div>
                <div class="tab" onclick="switchTab('movie')">–§–∏–ª—å–º—ã</div>
                <div class="tab" onclick="switchTab('anime')">–ê–Ω–∏–º–µ</div>
                <div class="tab" onclick="switchTab('series')">–°–µ—Ä–∏–∞–ª—ã</div>
                <div class="tab" onclick="switchTab('audiobook')">–ê—É–¥–∏–æ–∫–Ω–∏–≥–∏</div>
                <div class="tab" onclick="switchTab('story')">–†–∞—Å—Å–∫–∞–∑—ã</div>
                <div class="tab" onclick="switchTab('watching')">–°–º–æ—Ç—Ä—é</div>
                <div class="tab" onclick="switchTab('myshows')">üì∫ MyShows</div>
                <div class="tab" onclick="switchTab('franchises')">üß© –§—Ä–∞–Ω—à–∏–∑—ã</div>
                <div class="tab" onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="tab" onclick="openAchievements()">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            </div>
            <div class="filters-row">
                <select class="status-filter" id="statusFilter" onchange="filterCollections()">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    <option value="watched">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
                    <option value="listening">–°–ª—É—à–∞—é</option>
                    <option value="completed_audio">–ü—Ä–æ—Å–ª—É—à–∞–Ω–æ</option>
                    <option value="watching">–°–º–æ—Ç—Ä—é</option>
                    <option value="online">–û–Ω–ª–∞–π–Ω</option>
                    <option value="youtube">–û–±–∑–æ—Ä –Ω–∞ YouTube</option>
                </select>
                <select class="year-filter" id="yearFilter" onchange="filterCollections()">
                    <option value="all">–í—Å–µ –≥–æ–¥–∞</option>
                </select>
                <select class="letter-filter" id="letterFilter" onchange="filterCollections()">
                    <option value="all">–í—Å–µ –±—É–∫–≤—ã</option>
                    <option value="–ê">–ê</option>
                    <option value="–ë">–ë</option>
                    <option value="–í">–í</option>
                    <option value="–ì">–ì</option>
                    <option value="–î">–î</option>
                    <option value="–ï">–ï</option>
                    <option value="–Å">–Å</option>
                    <option value="–ñ">–ñ</option>
                    <option value="–ó">–ó</option>
                    <option value="–ò">–ò</option>
                    <option value="–ô">–ô</option>
                    <option value="–ö">–ö</option>
                    <option value="–õ">–õ</option>
                    <option value="–ú">–ú</option>
                    <option value="–ù">–ù</option>
                    <option value="–û">–û</option>
                    <option value="–ü">–ü</option>
                    <option value="–†">–†</option>
                    <option value="–°">–°</option>
                    <option value="–¢">–¢</option>
                    <option value="–£">–£</option>
                    <option value="–§">–§</option>
                    <option value="–•">–•</option>
                    <option value="–¶">–¶</option>
                    <option value="–ß">–ß</option>
                    <option value="–®">–®</option>
                    <option value="–©">–©</option>
                    <option value="–™">–™</option>
                    <option value="–´">–´</option>
                    <option value="–¨">–¨</option>
                    <option value="–≠">–≠</option>
                    <option value="–Æ">–Æ</option>
                    <option value="–Ø">–Ø</option>
                </select>
                <select class="genre-filter" id="genreFilter" onchange="filterCollections()">
                    <!-- –ñ–∞–Ω—Ä—ã –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
        </div>
        <div class="collections-grid" id="collectionsGrid"></div>
        <div class="table-view" id="tableView">
            <table class="collection-table">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ì–æ–¥</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–°–µ–∑–æ–Ω—ã / –°–µ—Ä–∏–∏</th>
                        <th>–¢–µ–≥–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-input" id="itemTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
            </div>
            <div class="form-group" style="text-align: right;">               
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>–¢–∏–ø</label>
                    <select class="form-input" id="itemType" onchange="toggleFields()">
                        <option value="game">–ò–≥—Ä–∞</option>
                        <option value="movie">–§–∏–ª—å–º</option>
                        <option value="anime">–ê–Ω–∏–º–µ</option>
                        <option value="series">–°–µ—Ä–∏–∞–ª</option>
                        <option value="audiobook">–ê—É–¥–∏–æ–∫–Ω–∏–≥–∞</option>
                        <option value="story">–†–∞—Å—Å–∫–∞–∑</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-input" id="itemStatus">
                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        <option value="watched">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
                        <option value="listening">–°–ª—É—à–∞—é</option>
                        <option value="completed_audio">–ü—Ä–æ—Å–ª—É—à–∞–Ω–æ</option>
                        <option value="watching">–°–º–æ—Ç—Ä—é</option>
                        <option value="online">–û–Ω–ª–∞–π–Ω</option>
                        <option value="youtube">–û–±–∑–æ—Ä –Ω–∞ YouTube</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>–ì–æ–¥</label>
                <input type="text" class="form-input" id="itemYear" placeholder="–ù–∞–ø—Ä.: 2005 –∏–ª–∏ 2005‚Äì2012" value="2025">
            </div>
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π</label>
                <input type="number" class="form-input" id="itemPlays" placeholder="1" min="1" value="1">
            </div>
            <div class="form-group" id="seasonsField" style="display: none;">
                <label>–°–µ–∑–æ–Ω—ã (–¥–ª—è –∞–Ω–∏–º–µ/—Å–µ—Ä–∏–∞–ª–æ–≤)</label>
                <input type="number" class="form-input" id="itemSeasons" placeholder="3" min="1">
            </div>
            <div class="form-group" id="episodesField" style="display: none;">
                <label>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ —Å–µ—Ä–∏–π</label>
                <input type="number" class="form-input" id="itemEpisodes" placeholder="24" min="0" value="0">
            </div>
            <div class="form-group" id="speedField" style="display: none;">
                <label>–°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</label>
                <select class="form-input" id="itemSpeed">
                    <option value="1.0">1.0x (–æ–±—ã—á–Ω–∞—è)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="1.75">1.75x</option>
                    <option value="2.0" selected>2.0x</option>
                    <option value="2.5">2.5x</option>
                    <option value="3.0">3.0x</option>
                </select>
            </div>
            <div class="form-group" id="totalEpisodesField" style="display: none;">
                <label>–í—Å–µ–≥–æ —Å–µ—Ä–∏–π (–¥–ª—è –∞–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)</label>
                <input type="number" class="form-input" id="itemTotalEpisodes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 24" min="1">
            </div>
            <div class="form-group">
                <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" class="form-input" id="itemImage" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label>–°–µ—Ä–∏—è / –§—Ä–∞–Ω—à–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" class="form-input" id="itemSeries" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–µ—Ä—Ö—ä–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ, –í–µ–¥—å–º–∞–∫">
            </div>
            <div class="form-group" id="authorField" style="display: none;">
                <label>–ê–≤—Ç–æ—Ä</label>
                <input type="text" class="form-input" id="itemAuthor" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∏–≤–µ–Ω –ö–∏–Ω–≥">
            </div>
            <div class="form-group" id="timeField" style="display: none;">
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π —Å–µ—Ä–∏–∏</label>
                <input type="text" class="form-input" id="itemTime" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 22 –º–∏–Ω, 43 –º–∏–Ω">
            </div>
            <div class="form-group">
                <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <div id="tagPicker" class="form-input" style="min-height:60px;padding:6px;display:flex;flex-wrap:wrap;gap:6px;align-items:flex-start;overflow:auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-add" id="saveButton" onclick="saveItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="close-image">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>
    <script>
        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≥–æ–¥–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ ===
        function getStartYear(yearStr) {
            if (typeof yearStr !== 'string') return 0;
            const match = yearStr.match(/^(\d{4})/);
            return match ? parseInt(match[1], 10) : 0;
        }

        let collections = [];
        let activeTab = 'all';
        let editingId = null;
        let currentView = 'grid';
        const STORAGE_KEY = 'myCollectionData';
        const TAB_KEY = 'myCollectionTab';
        const COLLAPSED_SERIES_KEY = 'collapsedSeries';
        let history = [];
        const MAX_HISTORY = 20;
        let collapsedSeries = new Set(JSON.parse(localStorage.getItem(COLLAPSED_SERIES_KEY) || '[]'));
        let currentScrollPosition = 0;

        function saveScrollPosition() {
            currentScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        }
        function restoreScrollPosition() {
            window.scrollTo(0, currentScrollPosition);
        }
        function saveCollapsedSeries() {
            localStorage.setItem(COLLAPSED_SERIES_KEY, JSON.stringify(Array.from(collapsedSeries)));
        }
        function saveToHistory() {
            if (history.length >= MAX_HISTORY) history.shift();
            history.push(JSON.parse(JSON.stringify(collections)));
        }
        function undoLastAction() {
            if (history.length === 0) {
                showNotification('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã!', 'error');
                return;
            }
            collections = history.pop();
            saveCollection();
            renderCollections();
            updateStats();
            updateYearFilter();
            updateGenreFilter();
            showNotification('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ!', 'success');
        }
        function clearAll() {
            if (confirm('‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–ß–ò–°–¢–ò–¢–¨ –í–°–Æ –ö–û–õ–õ–ï–ö–¶–ò–Æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                saveToHistory();
                collections = [];
                saveCollection();
                renderCollections();
                updateStats();
                updateYearFilter();
                updateGenreFilter();
                showNotification('–ö–æ–ª–ª–µ–∫—Ü–∏—è –æ—á–∏—â–µ–Ω–∞!', 'success');
            }
        }

        const TAG_COLORS = {
            '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞': 'fantasy',
            '—Ñ—ç–Ω—Ç–µ–∑–∏': 'fantasy',
            'sci-fi': 'scifi',
            '–Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞': 'scifi',
            '–¥—Ä–∞–º–∞': 'drama',
            '–∫–æ–º–µ–¥–∏—è': 'comedy',
            '—É–∂–∞—Å—ã': 'horror',
            '—Ö–æ—Ä—Ä–æ—Ä': 'horror',
            '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞': 'romance',
            '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è': 'adventure',
            '–±–æ–µ–≤–∏–∫': 'action',
            '—Ç—Ä–∏–ª–ª–µ—Ä': 'thriller',
            '–∫–≤–µ—Å—Ç': 'adventure',
            '—Å—Ç—Ä–∞—Ç–µ–≥–∏—è': 'strategy',
            '—à—É—Ç–µ—Ä': 'action',
            '—ç–∫—à–µ–Ω': 'action',
            '–∞—Ä–∫–∞–¥–∞': 'arcade',
            '–≥–æ–Ω–∫–∏': 'racing',
            '—Å–ø–æ—Ä—Ç': 'sports',
            '—Ñ–∞–π—Ç–∏–Ω–≥': 'fighting',
            '—Ä–æ–≥–∞–ª–∏–∫': 'roguelike',
            '–º–º–æ—Ä–ø–≥': 'mmorpg',
            '—Ä–ø–≥': 'rpg',
            '–ø–µ—Å–æ—á–Ω–∏—Ü–∞': 'sandbox',
            '–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä': 'platformer',
            '—Å–∏–º—É–ª—è—Ç–æ—Ä': 'simulation',
            '–ª–∏—Ç—Ä–ø–≥': 'rpg',
            '—Ä–µ–∞–ª—Ä–ø–≥': 'rpg',
            '–∏—Å–µ–∫–∞–π': 'fantasy'
        };

        const GENRE_OPTIONS = {
            all: [
                { value: '–¥—Ä–∞–º–∞', label: '–î—Ä–∞–º–∞' },
                { value: '–∫–æ–º–µ–¥–∏—è', label: '–ö–æ–º–µ–¥–∏—è' },
                { value: '–±–æ–µ–≤–∏–∫', label: '–ë–æ–µ–≤–∏–∫' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—É–∂–∞—Å—ã', label: '–£–∂–∞—Å—ã' },
                { value: '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞', label: '–†–æ–º–∞–Ω—Ç–∏–∫–∞' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '—Ç—Ä–∏–ª–ª–µ—Ä', label: '–¢—Ä–∏–ª–ª–µ—Ä' },
                { value: '–¥–µ—Ç–µ–∫—Ç–∏–≤', label: '–î–µ—Ç–µ–∫—Ç–∏–≤' },
                { value: '–±–∏–æ–≥—Ä–∞—Ñ–∏—è', label: '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è' },
                { value: '–∏—Å—Ç–æ—Ä–∏—è', label: '–ò—Å—Ç–æ—Ä–∏—è' },
                { value: '–º—É–ª—å—Ç—Ñ–∏–ª—å–º', label: '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º' },
                { value: '–≤–µ—Å—Ç–µ—Ä–Ω', label: '–í–µ—Å—Ç–µ—Ä–Ω' },
                { value: '–≤–æ–µ–Ω–Ω—ã–π', label: '–í–æ–µ–Ω–Ω—ã–π' },
                { value: '–º—É–∑—ã–∫–∞', label: '–ú—É–∑—ã–∫–∞' },
                { value: '—Å–ø–æ—Ä—Ç', label: '–°–ø–æ—Ä—Ç' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' }
            ],
            game: [
                { value: '—ç–∫—à–µ–Ω', label: '–≠–∫—à–µ–Ω' },
                { value: '—Ä–ø–≥', label: '–†–ü–ì' },
                { value: '—Å—Ç—Ä–∞—Ç–µ–≥–∏—è', label: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è' },
                { value: '–≤—ã–∂–∏–≤–∞–Ω–∏–µ', label: '–í—ã–∂–∏–≤–∞–Ω–∏–µ' },
                { value: '—Å–ª—ç—à–µ—Ä', label: '–°–ª—ç—à–µ—Ä' },
                { value: 'beat em up', label: 'Beat \'em up' },
                { value: '–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä', label: '–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä' },
                { value: '—Å–∏–º—É–ª—è—Ç–æ—Ä', label: '–°–∏–º—É–ª—è—Ç–æ—Ä' },
                { value: '–≥–æ–Ω–∫–∏', label: '–ì–æ–Ω–∫–∏' },
                { value: '—Å–ø–æ—Ä—Ç', label: '–°–ø–æ—Ä—Ç' },
                { value: '—Ñ–∞–π—Ç–∏–Ω–≥', label: '–§–∞–π—Ç–∏–Ω–≥' },
                { value: '–∞—Ä–∫–∞–¥–∞', label: '–ê—Ä–∫–∞–¥–∞' },
                { value: '–∫–≤–µ—Å—Ç', label: '–ö–≤–µ—Å—Ç' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '—Ö–æ—Ä—Ä–æ—Ä', label: '–•–æ—Ä—Ä–æ—Ä' },
                { value: '–ø–µ—Å–æ—á–Ω–∏—Ü–∞', label: '–ü–µ—Å–æ—á–Ω–∏—Ü–∞' },
                { value: '—Ä–æ–≥–∞–ª–∏–∫', label: '–†–æ–≥–∞–ª–∏–∫' },
                { value: '—Å—É—Ä–≤–∞–π–≤–ª —Ö–æ—Ä—Ä–æ—Ä', label: '–°—É—Ä–≤–∞–π–≤–ª —Ö–æ—Ä—Ä–æ—Ä' },
                { value: '—à—É—Ç–µ—Ä –æ—Ç 1 –ª–∏—Ü–∞', label: '–®—É—Ç–µ—Ä –æ—Ç 1 –ª–∏—Ü–∞' },
                { value: '—à—É—Ç–µ—Ä –æ—Ç 3 –ª–∏—Ü–∞', label: '–®—É—Ç–µ—Ä –æ—Ç 3 –ª–∏—Ü–∞' },
                { value: '–º–º–æ—Ä–ø–≥', label: '–ú–ú–û–†–ü–ì' }
            ],
            movie: [
                { value: '–¥—Ä–∞–º–∞', label: '–î—Ä–∞–º–∞' },
                { value: '–∫–æ–º–µ–¥–∏—è', label: '–ö–æ–º–µ–¥–∏—è' },
                { value: '–±–æ–µ–≤–∏–∫', label: '–ë–æ–µ–≤–∏–∫' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—É–∂–∞—Å—ã', label: '–£–∂–∞—Å—ã' },
                { value: '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞', label: '–†–æ–º–∞–Ω—Ç–∏–∫–∞' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '—Ç—Ä–∏–ª–ª–µ—Ä', label: '–¢—Ä–∏–ª–ª–µ—Ä' },
                { value: '–¥–µ—Ç–µ–∫—Ç–∏–≤', label: '–î–µ—Ç–µ–∫—Ç–∏–≤' },
                { value: '–±–∏–æ–≥—Ä–∞—Ñ–∏—è', label: '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è' },
                { value: '–∏—Å—Ç–æ—Ä–∏—è', label: '–ò—Å—Ç–æ—Ä–∏—è' },
                { value: '–º—É–ª—å—Ç—Ñ–∏–ª—å–º', label: '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º' },
                { value: '–≤–µ—Å—Ç–µ—Ä–Ω', label: '–í–µ—Å—Ç–µ—Ä–Ω' },
                { value: '–≤–æ–µ–Ω–Ω—ã–π', label: '–í–æ–µ–Ω–Ω—ã–π' },
                { value: '–º—É–∑—ã–∫–∞', label: '–ú—É–∑—ã–∫–∞' },
                { value: '—Å–ø–æ—Ä—Ç', label: '–°–ø–æ—Ä—Ç' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' }
            ],
            anime: [
                { value: '—Å—ë–Ω–µ–Ω', label: '–°—ë–Ω–µ–Ω' },
                { value: '—Å—ë–¥–∑—ë', label: '–°—ë–¥–∑—ë' },
                { value: '–¥—Ä–∞–º–∞', label: '–î—Ä–∞–º–∞' },
                { value: '–∫–æ–º–µ–¥–∏—è', label: '–ö–æ–º–µ–¥–∏—è' },
                { value: '–±–æ–µ–≤–∏–∫', label: '–ë–æ–µ–≤–∏–∫' },
                { value: '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞', label: '–†–æ–º–∞–Ω—Ç–∏–∫–∞' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å', label: '–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å' },
                { value: '–º–∞–≥–∏—è', label: '–ú–∞–≥–∏—è' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '—Ç—Ä–∏–ª–ª–µ—Ä', label: '–¢—Ä–∏–ª–ª–µ—Ä' },
                { value: '—É–∂–∞—Å—ã', label: '–£–∂–∞—Å—ã' },
                { value: '–º–µ—Ö–∞', label: '–ú–µ—Ö–∞' },
                { value: '—Å–ø–æ—Ä—Ç', label: '–°–ø–æ—Ä—Ç' },
                { value: '–∏—Å–µ–∫–∞–π', label: '–ò—Å–µ–∫–∞–π' }
            ],
            series: [
                { value: '–¥—Ä–∞–º–∞', label: '–î—Ä–∞–º–∞' },
                { value: '–∫–æ–º–µ–¥–∏—è', label: '–ö–æ–º–µ–¥–∏—è' },
                { value: '–∫—Ä–∏–º–∏–Ω–∞–ª', label: '–ö—Ä–∏–º–∏–Ω–∞–ª' },
                { value: '–±–æ–µ–≤–∏–∫', label: '–ë–æ–µ–≤–∏–∫' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—É–∂–∞—Å—ã', label: '–£–∂–∞—Å—ã' },
                { value: '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞', label: '–†–æ–º–∞–Ω—Ç–∏–∫–∞' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '—Ç—Ä–∏–ª–ª–µ—Ä', label: '–¢—Ä–∏–ª–ª–µ—Ä' },
                { value: '–¥–µ—Ç–µ–∫—Ç–∏–≤', label: '–î–µ—Ç–µ–∫—Ç–∏–≤' },
                { value: '–±–∏–æ–≥—Ä–∞—Ñ–∏—è', label: '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è' },
                { value: '–∏—Å—Ç–æ—Ä–∏—è', label: '–ò—Å—Ç–æ—Ä–∏—è' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' }
            ],
            audiobook: [
                { value: '—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', label: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–¥–µ—Ç–µ–∫—Ç–∏–≤', label: '–î–µ—Ç–µ–∫—Ç–∏–≤' },
                { value: '—Ä–æ–º–∞–Ω', label: '–†–æ–º–∞–Ω' },
                { value: '–±–∏–æ–≥—Ä–∞—Ñ–∏—è', label: '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è' },
                { value: '—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ', label: '–°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ' },
                { value: '–ª–∏—Ç—Ä–ø–≥', label: '–õ–∏—Ç–†–ü–ì' },
                { value: '—Ä–µ–∞–ª—Ä–ø–≥', label: '–†–µ–∞–ª–†–ü–ì' },
                { value: '–∏—Å—Ç–æ—Ä–∏—è', label: '–ò—Å—Ç–æ—Ä–∏—è' },
                { value: '–∫–ª–∞—Å—Å–∏–∫–∞', label: '–ö–ª–∞—Å—Å–∏–∫–∞' }
            ],
            story: [
                { value: '–∫–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑', label: '–ö–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑' },
                { value: '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', label: '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' },
                { value: '—Ñ—ç–Ω—Ç–µ–∑–∏', label: '–§—ç–Ω—Ç–µ–∑–∏' },
                { value: '–¥–µ—Ç–µ–∫—Ç–∏–≤', label: '–î–µ—Ç–µ–∫—Ç–∏–≤' },
                { value: '—Ä–æ–º–∞–Ω—Ç–∏–∫–∞', label: '–†–æ–º–∞–Ω—Ç–∏–∫–∞' },
                { value: '—É–∂–∞—Å—ã', label: '–£–∂–∞—Å—ã' },
                { value: '–¥—Ä–∞–º–∞', label: '–î—Ä–∞–º–∞' },
                { value: '—é–º–æ—Ä', label: '–Æ–º–æ—Ä' },
                { value: '–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', label: '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' },
                { value: '–ª–∏—Ç—Ä–ø–≥', label: '–õ–∏—Ç–†–ü–ì' },
                { value: '—Ä–µ–∞–ª—Ä–ø–≥', label: '–†–µ–∞–ª–†–ü–ì' }
            ]
        };

        // === –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–≥–æ–≤ –∏–∑ –∂–∞–Ω—Ä–æ–≤ (–ø–∏–ª—é–ª–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞) ===
        function updateTagSelect() {
            const picker = document.getElementById('tagPicker');
            const type = document.getElementById('itemType').value;
            picker.innerHTML = '';
            const genres = GENRE_OPTIONS[type] || GENRE_OPTIONS.all;
            genres.forEach(g => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = g.label;
                btn.dataset.value = g.value;
                btn.className = 'tag-pill';
                btn.style.background = '#3a3a5a';
                btn.style.color = '#e6e6e6';
                btn.style.border = 'none';
                btn.style.padding = '4px 10px';
                btn.style.borderRadius = '10px';
                btn.style.cursor = 'pointer';
                btn.style.fontSize = '0.85rem';
                btn.onclick = () => btn.classList.toggle('selected');
                picker.appendChild(btn);
            });
        }
        function getSelectedTags() {
            return Array.from(document.querySelectorAll('#tagPicker .tag-pill.selected')).map(el => el.dataset.value);
        }
        function setTagSelection(tags) {
            if (!tags || !Array.isArray(tags)) return;
            updateTagSelect();
            setTimeout(() => {
                const pills = document.querySelectorAll('#tagPicker .tag-pill');
                pills.forEach(p => {
                    if (tags.includes(p.dataset.value)) p.classList.add('selected');
                });
            }, 50);
        }

        // === –ò–°–ü–†–ê–í–õ–ï–ù–û: parseTimeAdvanced ‚Äî —É–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∫–æ–¥ ===
        function parseTimeAdvanced(timeStr) {
            if (!timeStr) return { hours: 0, minutes: 0, days: 0 };
            let hours = 0, minutes = 0, days = 0;
            const lowerStr = timeStr.toLowerCase();

            // –§–æ—Ä–º–∞—Ç "1:30", "2.45", "3,15"
            const timeMatch = lowerStr.match(/(\d+)[.:,](\d+)/);
            if (timeMatch) {
                hours = parseInt(timeMatch[1]);
                const minsOrFraction = parseInt(timeMatch[2]);
                if (minsOrFraction < 60) {
                    minutes = minsOrFraction;
                } else {
                    hours += minsOrFraction / 100;
                }
                return { hours, minutes, days };
            }

            // –§–æ—Ä–º–∞—Ç "120 –º–∏–Ω"
            const minMatch = lowerStr.match(/(\d+)\s*–º–∏–Ω/);
            if (minMatch) {
                const totalMins = parseInt(minMatch[1]);
                hours = Math.floor(totalMins / 60);
                minutes = totalMins % 60;
                return { hours, minutes, days };
            }

            // –§–æ—Ä–º–∞—Ç "2 —á–∞—Å–∞", "5 —á–∞—Å"
            const hourMatch = lowerStr.match(/(\d+)\s*—á–∞—Å/);
            if (hourMatch) {
                hours = parseInt(hourMatch[1]);
                return { hours, minutes, days };
            }

            // –§–æ—Ä–º–∞—Ç "3 –¥–Ω—è", "1 –¥–Ω"
            const dayMatch = lowerStr.match(/(\d+)\s*–¥–Ω/);
            if (dayMatch) {
                days = parseInt(dayMatch[1]);
                return { hours, minutes, days };
            }

            // –§–æ—Ä–º–∞—Ç "4 —á"
            const hoursMatch = lowerStr.match(/(\d+)\s*—á/);
            if (hoursMatch) {
                hours = parseInt(hoursMatch[1]);
            }

            // –§–æ—Ä–º–∞—Ç "15 –º–∏–Ω" (–µ—â—ë —Ä–∞–∑, –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –≤—ã—à–µ)
            const minutesMatch = lowerStr.match(/(\d+)\s*–º–∏–Ω/);
            if (minutesMatch) {
                minutes = parseInt(minutesMatch[1]);
            }

            // –§–æ—Ä–º–∞—Ç "2 –¥–Ω"
            const daysMatch = lowerStr.match(/(\d+)\s*–¥–Ω/);
            if (daysMatch) {
                days = parseInt(daysMatch[1]);
            }

            // –¢–æ–ª—å–∫–æ —á–∏—Å–ª–æ ‚Üí –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –∫–∞–∫ —á–∞—Å—ã
            const numberOnly = lowerStr.match(/^(\d+)$/);
            if (numberOnly && hours === 0 && minutes === 0 && days === 0) {
                hours = parseInt(numberOnly[1]);
            }

            return { hours, minutes, days };
        }

        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–Å–¢–ê –í–†–ï–ú–ï–ù–ò ===
        function getTotalMinutes(item) {
            if (item.type === 'anime' || item.type === 'series') {
                const totalEpisodes = item.episodes || 0;
                const plays = item.plays || 1;
                const speed = item.speed || 1.0;
                if (item.time) {
                    const parsed = parseTimeAdvanced(item.time);
                    const minutesPerEpisode = parsed.days * 24 * 60 + parsed.hours * 60 + parsed.minutes;
                    const realMinutesPerEpisode = minutesPerEpisode / speed;
                    return Math.round(realMinutesPerEpisode * totalEpisodes * plays);
                } else {
                    return Math.round((22 / speed) * totalEpisodes * plays);
                }
            } else if (item.time) {
                const parsed = parseTimeAdvanced(item.time);
                const baseMins = parsed.days * 24 * 60 + parsed.hours * 60 + parsed.minutes;
                return baseMins * (item.plays || 1);
            }
            return 0;
        }

        function formatTotalTime(totalHours, totalMinutes) {
            const totalMins = totalHours * 60 + totalMinutes;
            const days = Math.floor(totalMins / (24 * 60));
            const remainingMins = totalMins % (24 * 60);
            const hours = Math.floor(remainingMins / 60);
            const mins = remainingMins % 60;
            let result = '';
            if (days > 0) result += `${days}–¥ `;
            if (hours > 0) result += `${hours}—á `;
            if (mins > 0) result += `${mins}–º–∏–Ω`;
            return result || '0—á 0–º–∏–Ω';
        }

        function formatTimeNicelyFromMinutes(totalMinutes) {
            if (totalMinutes <= 0) return '0 –º–∏–Ω';
            const days = Math.floor(totalMinutes / (24 * 60));
            const remaining = totalMinutes % (24 * 60);
            const hours = Math.floor(remaining / 60);
            const mins = remaining % 60;
            let parts = [];
            if (days > 0) parts.push(`${days}–¥`);
            if (hours > 0) parts.push(`${hours}—á`);
            if (mins > 0) parts.push(`${mins}–º–∏–Ω`);
            return parts.join(' ');
        }

        function toggleSeries(seriesName) {
            const itemsInSeries = collections.filter(item => item.series === seriesName);
            if (itemsInSeries.length <= 1) return;
            itemsInSeries.sort((a, b) => {
                const yearA = getStartYear(a.year) || 0; // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                const yearB = getStartYear(b.year) || 0; // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                if (yearA !== yearB) return yearA - yearB;
                return (a.id || 0) - (b.id || 0);
            });
            const firstItemId = itemsInSeries[0].id;
            if (collapsedSeries.has(seriesName)) {
                collapsedSeries.delete(seriesName);
                document.querySelectorAll(`[data-series="${CSS.escape(seriesName)}"]`).forEach(el => {
                    el.classList.remove('collapsed-hidden');
                });
            } else {
                collapsedSeries.add(seriesName);
                document.querySelectorAll(`[data-series="${CSS.escape(seriesName)}"]`).forEach(el => {
                    const itemId = parseInt(el.getAttribute('data-id'));
                    if (itemId !== firstItemId) {
                        el.classList.add('collapsed-hidden');
                    } else {
                        el.classList.remove('collapsed-hidden');
                    }
                });
            }
            saveCollapsedSeries();
        }

        // === –ò–°–ü–†–ê–í–õ–ï–ù–û: filterByGenre –æ–±—ä—è–≤–ª–µ–Ω–∞ –î–û renderCollections ===
        function filterByGenre(collection) {
            const genreFilter = document.getElementById('genreFilter').value;
            if (genreFilter === 'all') return collection;
            return collection.filter(item => {
                if (!item.tags) return false;
                return item.tags.some(tag => {
                    const lowerTag = tag.toLowerCase();
                    const lowerGenre = genreFilter.toLowerCase();
                    return lowerTag.includes(lowerGenre) || lowerGenre.includes(lowerTag);
                });
            });
        }

        function importCollection(event, replace = false) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    saveToHistory();
                    if (replace) {
                        collections = imported;
                    } else {
                        collections = [...collections, ...imported];
                    }
                    saveCollection();
                    renderCollections();
                    updateStats();
                    updateYearFilter();
                    updateGenreFilter();
                    showNotification('–≠–ª–µ–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!', 'success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞!', 'error');
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function importCSVCollection(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const parsed = parseCSV(csvText);
                    if (parsed.length === 0) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å CSV —Ñ–∞–π–ª');
                    saveToHistory();
                    collections = [...collections, ...parsed];
                    saveCollection();
                    renderCollections();
                    updateStats();
                    updateYearFilter();
                    updateGenreFilter();
                    showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${parsed.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤!`, 'success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV —Ñ–∞–π–ª–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.', 'error');
                }
                event.target.value = '';
            };
            reader.readAsText(file, 'utf-8');
        }

        function exportCollection() {
            if (collections.length === 0) {
                showNotification('–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞!', 'error');
                return;
            }
            const dataStr = JSON.stringify(collections, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `my-collection-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('–ö–æ–ª–ª–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
        }

        // === –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø saveItem ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –ª–µ—Ç ===
        function saveItem() {
            const title = document.getElementById('itemTitle').value.trim();
            if (!title) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!', 'error');
                return;
            }
            const type = document.getElementById('itemType').value;
            const image = document.getElementById('itemImage').value.trim();
            const yearInput = document.getElementById('itemYear').value.trim();
            if (!yearInput) {
                showNotification('–ì–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!', 'error');
                return;
            }
            // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 2005, 2005‚Äì2012, 2010-2024
            const yearRangeRegex = /^(\d{4})[-‚Äì](\d{4})$/;
            const singleYearRegex = /^\d{4}$/;
            if (!singleYearRegex.test(yearInput) && !yearRangeRegex.test(yearInput)) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≥–æ–¥–∞. –ü—Ä–∏–º–µ—Ä—ã: 2005, 2005-2012, 2005‚Äì2012', 'error');
                return;
            }

            saveToHistory();
            const newItem = {
                title: title,
                type: type,
                status: document.getElementById('itemStatus').value,
                year: yearInput, // –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
                plays: parseInt(document.getElementById('itemPlays').value) || 1,
                tags: getSelectedTags()
            };

            if (type === 'audiobook' || type === 'story') {
                const author = document.getElementById('itemAuthor').value.trim();
                if (author) newItem.author = author;
            }
            if (image) {
                newItem.image = image;
            }
            if (type === 'movie' || type === 'anime' || type === 'series' || type === 'audiobook' || type === 'story') {
                newItem.time = document.getElementById('itemTime').value.trim();
            }
            const series = document.getElementById('itemSeries').value.trim();
            if (series) newItem.series = series;

            if (type === 'anime' || type === 'series') {
                const seasons = document.getElementById('itemSeasons').value.trim();
                const episodes = document.getElementById('itemEpisodes').value.trim();
                const speed = document.getElementById('itemSpeed').value;
                const totalEpisodes = document.getElementById('itemTotalEpisodes').value.trim();
                if (seasons) newItem.seasons = parseInt(seasons) || 1;
                newItem.episodes = parseInt(episodes) || 0;
                newItem.speed = parseFloat(speed) || 1.0;
                if (totalEpisodes) newItem.totalEpisodes = parseInt(totalEpisodes);
            }

            if (editingId) {
                const index = collections.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    newItem.id = editingId;
                    collections[index] = newItem;
                }
            } else {
                newItem.id = Date.now();
                collections.unshift(newItem);
            }

            saveCollection();
            renderCollections();
            updateStats();
            updateYearFilter();
            updateGenreFilter();
            closeModal();
            const action = editingId ? '–∏–∑–º–µ–Ω–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω';
            showNotification(`–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ ${action}!`, 'success');
        }

        function deleteItem(id) {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
                saveToHistory();
                collections = collections.filter(i => i.id !== id);
                saveCollection();
                renderCollections();
                updateStats();
                updateYearFilter();
                updateGenreFilter();
                setTimeout(() => window.scrollTo(0, scrollPosition), 100);
                showNotification('–≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!', 'success');
            }
        }

        function addEpisode(id) {
            const item = collections.find(i => i.id === id);
            if (!item || (item.type !== 'anime' && item.type !== 'series')) return;
            saveToHistory();
            item.episodes = (item.episodes || 0) + 1;
            if (item.totalEpisodes && item.episodes >= item.totalEpisodes) {
                item.status = 'watched';
                showNotification('–°–µ—Ä–∏–∞–ª/–∞–Ω–∏–º–µ –∑–∞–≤–µ—Ä—à—ë–Ω –∏ –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫!', 'success');
            }
            saveCollection();
            renderCollections();
            updateStats();
            if (item.status !== 'watched') {
                showNotification('–°–µ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
            }
        }

        function renderGrid(filtered) {
            const grid = document.getElementById('collectionsGrid');
            const table = document.getElementById('tableView');
            grid.style.display = 'grid';
            table.classList.remove('active');
            if (filtered.length === 0) {
                grid.innerHTML = `<div class="empty-state"><h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</p></div>`;
                return;
            }
            grid.innerHTML = filtered.map(item => {
                const imageSrc = getImageUrl(item);
                const isSeries = item.series && item.type === 'audiobook';
                const isOnline = item.status === 'online' && item.type === 'game';
                const isYoutube = item.status === 'youtube' && item.type === 'game';
                let extraInfo = '';
                if (isSeries) {
                    extraInfo += `<div class="item-series">üìñ ${item.series}</div>`;
                }
                if (item.author) {
                    extraInfo += `<div class="item-year">üë§ ${item.author}</div>`;
                }
                if (item.type === 'anime' || item.type === 'series') {
                    const totalMins = getTotalMinutes(item);
                    if (totalMins > 0) {
                        extraInfo += `<div class="item-time">‚è±Ô∏è ${formatTimeNicelyFromMinutes(totalMins)}</div>`;
                    }
                } else if (item.time) {
                    extraInfo += `<div class="item-time">‚è±Ô∏è ${formatTimeNicely(item.time)}</div>`;
                }
                if (item.plays && item.plays > 1) {
                    extraInfo += `<div class="item-time">üîÑ ${item.plays} —Ä–∞–∑(–∞)</div>`;
                }
                if ((item.type === 'anime' || item.type === 'series') && (item.seasons || item.episodes)) {
                    const s = item.seasons || '?';
                    const e = item.episodes || 0;
                    extraInfo += `<div class="item-series-info">üì∫ ${s} —Å–µ–∑–æ–Ω(–æ–≤), ${e} —Å–µ—Ä–∏–π</div>`;
                }
                if ((item.type === 'anime' || item.type === 'series') && item.speed && item.speed !== 1.0) {
                    extraInfo += `<div class="item-time">‚è© ${item.speed}x</div>`;
                }
                let actionBtns = `
                    <button type="button" class="edit-btn" onclick="event.stopPropagation(); openEditModal(${item.id});">‚úé</button>
                    <button type="button" class="delete-btn" onclick="event.stopPropagation(); deleteItem(${item.id});">√ó</button>`;
                if (item.type === 'anime' || item.type === 'series') {
                    actionBtns += `<button class="add-episode-btn" onclick="event.stopPropagation(); addEpisode(${item.id});">+</button>`;
                }
                const toggleBtn = item.series ? `<button class="toggle-series-btn" onclick="event.stopPropagation(); toggleSeries('${item.series.replace(/'/g, "\\'")}');">üìÇ</button>` : '';
                return `
                    <div class="collection-item ${isSeries ? 'series-highlight' : ''}" data-series="${item.series || ''}" data-id="${item.id}" onclick="openImageModal('${imageSrc}')">
                        <div class="action-btns">${actionBtns}</div>
                        <img src="${imageSrc}" alt="${item.title}" class="item-image">
                        <div class="item-content">
                            <div class="item-title"><span>${item.title}</span><span>${item.type === 'game' ? 'üéÆ' : item.type === 'movie' ? 'üé¨' : item.type === 'anime' ? 'üì∫' : item.type === 'series' ? 'üì∫' : item.type === 'audiobook' ? 'üéß' : 'üìñ'} ${toggleBtn}</span></div>
                            <div class="item-year">üìÖ ${item.year}</div>
                            <div class="item-status ${isOnline ? 'status-online' : isYoutube ? 'status-youtube' : ''} ${item.status === 'completed' || item.status === 'watched' || item.status === 'completed_audio' ? 'status-completed' : item.status === 'listening' || item.status === 'reading' || item.status === 'playing' ? 'status-listening' : item.status === 'online' ? 'status-online' : item.status === 'youtube' ? 'status-youtube' : item.status === 'watching' ? 'status-watching' : ''}">${getStatusText(item.status, item.type)}</div>
                            ${extraInfo}
                            <div class="item-tags">${(item.tags || []).map(tag => `<span class="tag ${getTagClass(tag)}">${tag}</span>`).join('')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            applyCollapsedState();
        }

        function applyCollapsedState() {
            collapsedSeries.forEach(seriesName => {
                const itemsInSeries = collections.filter(item => item.series === seriesName);
                if (itemsInSeries.length <= 1) return;
                itemsInSeries.sort((a, b) => {
                    const yearA = getStartYear(a.year) || 0;
                    const yearB = getStartYear(b.year) || 0;
                    if (yearA !== yearB) return yearA - yearB;
                    return (a.id || 0) - (b.id || 0);
                });
                const firstItemId = itemsInSeries[0].id;
                document.querySelectorAll(`[data-series="${CSS.escape(seriesName)}"]`).forEach(el => {
                    const itemId = parseInt(el.getAttribute('data-id'));
                    if (itemId !== firstItemId) {
                        el.classList.add('collapsed-hidden');
                    } else {
                        el.classList.remove('collapsed-hidden');
                    }
                });
            });
        }

        function normalizeType(type) {
            const lowerType = type.toLowerCase().trim();
            if (lowerType === 'game' || lowerType === '–∏–≥—Ä–∞' || lowerType === '–∏–≥—Ä—ã') return 'game';
            if (lowerType === 'movie' || lowerType === '—Ñ–∏–ª—å–º' || lowerType === '—Ñ–∏–ª—å–º—ã' || lowerType === 'film') return 'movie';
            if (lowerType === 'anime' || lowerType === '–∞–Ω–∏–º–µ') return 'anime';
            if (lowerType === 'series' || lowerType === '—Å–µ—Ä–∏–∞–ª' || lowerType === '—Å–µ—Ä–∏–∞–ª—ã') return 'series';
            if (lowerType === 'audiobook' || lowerType === '–∞—É–¥–∏–æ–∫–Ω–∏–≥–∞' || lowerType === '–∞—É–¥–∏–æ–∫–Ω–∏–≥–∏') return 'audiobook';
            if (lowerType === 'story' || lowerType === '—Ä–∞—Å—Å–∫–∞–∑' || lowerType === '—Ä–∞—Å—Å–∫–∞–∑—ã' || lowerType === 'short story') return 'story';
            return 'game';
        }

        function normalizeStatus(status) {
            const lowerStatus = status.toLowerCase();
            if (lowerStatus.includes('youtube') || lowerStatus.includes('—é—Ç—É–±') || lowerStatus.includes('–æ–±–∑–æ—Ä')) return 'youtube';
            if (lowerStatus.includes('–æ–Ω–ª–∞–π–Ω') || lowerStatus.includes('online')) return 'online';
            if (lowerStatus.includes('–∑–∞–≤–µ—Ä—à–µ–Ω–æ') || lowerStatus.includes('completed') || lowerStatus.includes('–ø—Ä–æ–π–¥–µ–Ω–æ')) return 'completed';
            if (lowerStatus.includes('–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ') || lowerStatus.includes('watched')) return 'watched';
            if (lowerStatus.includes('—Å–ª—É—à–∞—é') || lowerStatus.includes('listening')) return 'listening';
            if (lowerStatus.includes('–ø—Ä–æ—Å–ª—É—à–∞–Ω–æ') || lowerStatus.includes('completed_audio')) return 'completed_audio';
            if (lowerStatus.includes('—á–∏—Ç–∞—é') || lowerStatus.includes('reading')) return 'reading';
            if (lowerStatus.includes('–∏–≥—Ä–∞—é') || lowerStatus.includes('playing')) return 'playing';
            if (lowerStatus.includes('—Å–º–æ—Ç—Ä—é') || lowerStatus.includes('watching')) return 'watching';
            return 'completed';
        }

        function switchTab(type) {
            activeTab = type;
            localStorage.setItem(TAB_KEY, type);
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            if (type === 'stats') {
                document.querySelector('.search-container').style.display = 'block';
                renderStats();
            } else if (type === 'franchises') {
                document.querySelector('.header-title h1').textContent = 'üß© –§—Ä–∞–Ω—à–∏–∑—ã';
                document.querySelector('.search-container').style.display = 'none';
                renderFranchisesByType();
            } else if (type === 'myshows') {
                document.querySelector('.search-container').style.display = 'block';
                document.querySelector('.header-title h1').textContent = 'üì∫ MyShows';
                const watchingItems = collections.filter(item => (item.type === 'anime' || item.type === 'series') && item.status === 'watching');
                renderMyShowsMode(watchingItems);
            } else {
                document.querySelector('.header-title h1').textContent = '–ú–æ—è –ö–æ–ª–ª–µ–∫—Ü–∏—è';
                document.querySelector('.search-container').style.display = 'block';
                updateGenreFilter();
                filterCollections();
            }
        }

        function renderStats() {
            const stats = getYearlyStats();
            const grid = document.getElementById('collectionsGrid');
            grid.style.display = 'grid';
            document.getElementById('tableView').classList.remove('active');
            const games = collections.filter(i => i.type === 'game').length;
            const movies = collections.filter(i => i.type === 'movie').length;
            const anime = collections.filter(i => i.type === 'anime').length;
            const series = collections.filter(i => i.type === 'series').length;
            const audiobooks = collections.filter(i => i.type === 'audiobook').length;
            const stories = collections.filter(i => i.type === 'story').length;
            const movieTotalMins = collections.filter(i => i.type === 'movie').reduce((sum, m) => sum + getTotalMinutes(m), 0);
            const animeTotalMins = collections.filter(i => i.type === 'anime').reduce((sum, a) => sum + getTotalMinutes(a), 0);
            const seriesTotalMins = collections.filter(i => i.type === 'series').reduce((sum, s) => sum + getTotalMinutes(s), 0);
            const audiobookTotalMins = collections.filter(i => i.type === 'audiobook').reduce((sum, b) => sum + getTotalMinutes(b), 0);
            const storyTotalMins = collections.filter(i => i.type === 'story').reduce((sum, s) => sum + getTotalMinutes(s), 0);
            const totalEpisodesWatched = collections.filter(i => (i.type === 'anime' || i.type === 'series') && i.episodes).reduce((sum, i) => sum + (parseInt(i.episodes) || 0), 0);
            const totalMinutes = movieTotalMins + animeTotalMins + seriesTotalMins + audiobookTotalMins + storyTotalMins;
            const totalTimeStr = formatTotalTime(Math.floor(totalMinutes / 60), totalMinutes % 60);
            let statsHtml = `<div class="collection-item" style="background: rgba(60, 60, 90, 0.7); grid-column: 1 / -1;"><div class="item-content"><div class="item-title" style="justify-content: center; font-size: 1.4rem; color: #4fc3f7;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;"><div>üéÆ –ò–≥—Ä: <strong>${games}</strong></div><div>üé¨ –§–∏–ª—å–º–æ–≤: <strong>${movies}</strong></div><div>üì∫ –ê–Ω–∏–º–µ: <strong>${anime}</strong></div><div>üì∫ –°–µ—Ä–∏–∞–ª–æ–≤: <strong>${series}</strong></div><div>üéß –ê—É–¥–∏–æ–∫–Ω–∏–≥: <strong>${audiobooks}</strong></div><div>üìñ –†–∞—Å—Å–∫–∞–∑–æ–≤: <strong>${stories}</strong></div><div>‚è±Ô∏è –í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: <strong>${totalTimeStr}</strong></div><div>üéûÔ∏è –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ —Å–µ—Ä–∏–π: <strong>${totalEpisodesWatched}</strong></div></div></div></div>`;
            if (stats.length === 0) {
                statsHtml += `<div class="empty-state" style="grid-column: 1 / -1;"><h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3><p>–î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥–æ–¥–∞</p></div>`;
            } else {
                statsHtml += stats.map(item => `<div class="collection-item" style="background: rgba(60, 60, 90, 0.7);"><div class="item-content"><div class="item-title" style="justify-content: center; font-size: 1.4rem; color: #4fc3f7;">üìÖ ${item.year}</div><div style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"><div>üéÆ –ò–≥—Ä: <strong>${item.games}</strong></div><div>üé¨ –§–∏–ª—å–º–æ–≤: <strong>${item.movies}</strong></div><div>üì∫ –ê–Ω–∏–º–µ: <strong>${item.anime}</strong></div><div>üì∫ –°–µ—Ä–∏–∞–ª–æ–≤: <strong>${item.series}</strong></div></div></div></div>`).join('');
            }
            grid.innerHTML = statsHtml;
        }

        function filterByLetter(collection) {
            const letterFilter = document.getElementById('letterFilter').value;
            if (letterFilter === 'all') return collection;
            return collection.filter(item => {
                if (item.type === 'audiobook' || item.type === 'story') {
                    if (item.author) {
                        const firstChar = item.author.charAt(0).toUpperCase();
                        return firstChar === letterFilter;
                    }
                    return false;
                } else {
                    const firstChar = item.title.charAt(0).toUpperCase();
                    return firstChar === letterFilter;
                }
            });
        }

        function toggleFields() {
            const type = document.getElementById('itemType').value;
            const seasonsField = document.getElementById('seasonsField');
            const episodesField = document.getElementById('episodesField');
            const speedField = document.getElementById('speedField');
            const totalEpisodesField = document.getElementById('totalEpisodesField');
            const authorField = document.getElementById('authorField');
            const timeField = document.getElementById('timeField');
            if (type === 'anime' || type === 'series') {
                seasonsField.style.display = 'block';
                episodesField.style.display = 'block';
                speedField.style.display = 'block';
                totalEpisodesField.style.display = 'block';
                timeField.style.display = 'block';
                document.getElementById('itemTime').placeholder = "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π —Å–µ—Ä–∏–∏ (–Ω–∞–ø—Ä.: 22 –º–∏–Ω)";
            } else {
                seasonsField.style.display = 'none';
                episodesField.style.display = 'none';
                speedField.style.display = 'none';
                totalEpisodesField.style.display = 'none';
            }
            if (type === 'audiobook' || type === 'story') {
                authorField.style.display = 'block';
            } else {
                authorField.style.display = 'none';
            }
            if (type === 'movie' || type === 'anime' || type === 'series' || type === 'audiobook' || type === 'story') {
                if (type !== 'anime' && type !== 'series') {
                    timeField.style.display = 'block';
                    document.getElementById('itemTime').placeholder = "–û–±—â–µ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä.: 2:30, 120 –º–∏–Ω)";
                }
            } else {
                timeField.style.display = 'none';
            }
        }

        function openEditModal(id) {
            const item = collections.find(item => item.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç';
            document.getElementById('saveButton').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            document.getElementById('saveButton').className = 'btn btn-save';
            document.getElementById('itemType').disabled = true;
            document.getElementById('itemTitle').value = item.title;
            document.getElementById('itemType').value = item.type;
            document.getElementById('itemStatus').value = item.status;
            document.getElementById('itemYear').value = item.year;
            document.getElementById('itemPlays').value = item.plays || 1;
            document.getElementById('itemImage').value = item.image || '';
            document.getElementById('itemSeries').value = item.series || '';
            document.getElementById('itemAuthor').value = item.author || '';
            document.getElementById('itemTime').value = item.time || '';
            document.getElementById('itemSeasons').value = item.seasons || '';
            document.getElementById('itemEpisodes').value = item.episodes || 0;
            document.getElementById('itemSpeed').value = item.speed || '1.0';
            document.getElementById('itemTotalEpisodes').value = item.totalEpisodes || '';
            toggleFields();
            document.getElementById('addModal').classList.add('active');
            setTagSelection(item.tags || []);
        }

        // === –ò–°–ü–†–ê–í–õ–ï–ù–û: getYearlyStats –∏—Å–ø–æ–ª—å–∑—É–µ—Ç getStartYear ===
        function getYearlyStats() {
            const statsByYear = {};
            collections.forEach(item => {
                const year = getStartYear(item.year).toString(); // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                if (!year || year === '0') return;
                if (!statsByYear[year]) {
                    statsByYear[year] = { games: 0, movies: 0, anime: 0, series: 0 };
                }
                if (item.type === 'game') statsByYear[year].games++;
                else if (item.type === 'movie') statsByYear[year].movies++;
                else if (item.type === 'anime') statsByYear[year].anime++;
                else if (item.type === 'series') statsByYear[year].series++;
            });
            return Object.entries(statsByYear)
                .map(([year, data]) => ({ year, ...data }))
                .sort((a, b) => b.year - a.year);
        }

        // === –ò–°–ü–†–ê–í–õ–ï–ù–û: sortCollection –∏—Å–ø–æ–ª—å–∑—É–µ—Ç getStartYear ===
        function sortCollection(collection) {
            const sortValue = document.getElementById('sortSelect').value;
            return collection.sort((a, b) => {
                if ((a.type === 'audiobook' || a.type === 'story') && (b.type === 'audiobook' || b.type === 'story')) {
                    const authorA = a.author || '';
                    const authorB = b.author || '';
                    if (authorA !== authorB) {
                        return authorA.localeCompare(authorB, 'ru');
                    }
                }
                if (sortValue === 'popular') {
                    const playsA = a.plays || 1;
                    const playsB = b.plays || 1;
                    if (playsA > 1 && playsB <= 1) return -1;
                    if (playsB > 1 && playsA <= 1) return 1;
                    if (playsA > 1 && playsB > 1) return playsB - playsA;
                    return getStartYear(b.year) - getStartYear(a.year); // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                }
                switch (sortValue) {
                    case 'date_desc':
                        return getStartYear(b.year) - getStartYear(a.year); // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                    case 'date_asc':
                        return getStartYear(a.year) - getStartYear(b.year); // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                    case 'title_asc':
                        return a.title.localeCompare(b.title, 'ru');
                    case 'title_desc':
                        return b.title.localeCompare(a.title, 'ru');
                    default:
                        return 0;
                }
            });
        }      

        function formatTimeNicely(timeInput) {
            if (!timeInput) return '';
            if (typeof timeInput === 'number') {
                const hours = Math.floor(timeInput / 60);
                const mins = timeInput % 60;
                if (hours > 0 && mins > 0) return `${hours}—á ${mins}–º–∏–Ω`;
                if (hours > 0) return `${hours}—á`;
                return `${mins}–º–∏–Ω`;
            }
            const parsed = parseTimeAdvanced(timeInput);
            const totalMins = parsed.days * 24 * 60 + parsed.hours * 60 + parsed.minutes;
            if (totalMins === 0) return timeInput;
            const hours = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            if (hours > 0 && mins > 0) return `${hours}—á ${mins}–º–∏–Ω`;
            if (hours > 0) return `${hours}—á`;
            return `${mins}–º–∏–Ω`;
        }

        function loadCollection() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    collections = JSON.parse(saved);
                } else {
                    collections = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                collections = [];
            }
        }

        function saveCollection() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(collections));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö!', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'error' ? 'error' : ''} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const nameIndex = headers.findIndex(h => h.toLowerCase().includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || h.toLowerCase() === 'name' || h.toLowerCase() === 'title');
            const typeIndex = headers.findIndex(h => h.toLowerCase().includes('—Ç–∏–ø') || h.toLowerCase() === 'type');
            const statusIndex = headers.findIndex(h => h.toLowerCase().includes('—Å—Ç–∞—Ç—É—Å') || h.toLowerCase() === 'status');
            const yearIndex = headers.findIndex(h => h.toLowerCase().includes('–≥–æ–¥') || h.toLowerCase() === 'year');
            const timeIndex = headers.findIndex(h => h.toLowerCase().includes('–≤—Ä–µ–º—è') || h.toLowerCase() === 'time');
            const seriesIndex = headers.findIndex(h => h.toLowerCase().includes('—Å–µ—Ä–∏—è') || h.toLowerCase() === 'series');
            const seasonsIndex = headers.findIndex(h => h.toLowerCase().includes('—Å–µ–∑–æ–Ω') || h.toLowerCase() === 'seasons');
            const episodesIndex = headers.findIndex(h => h.toLowerCase().includes('—Å–µ—Ä–∏–∏') || h.toLowerCase() === 'episodes');
            const playsIndex = headers.findIndex(h => h.toLowerCase().includes('–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π') || h.toLowerCase().includes('–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤') || h.toLowerCase().includes('plays'));
            const tagsIndex = headers.findIndex(h => h.toLowerCase().includes('—Ç–µ–≥–∏') || h.toLowerCase() === 'tags');
            const imageIndex = headers.findIndex(h => h.toLowerCase().includes('–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') || h.toLowerCase() === 'image' || h.toLowerCase() === 'url');
            const authorIndex = headers.findIndex(h => h.toLowerCase().includes('–∞–≤—Ç–æ—Ä') || h.toLowerCase() === 'author');
            const speedIndex = headers.findIndex(h => h.toLowerCase().includes('—Å–∫–æ—Ä–æ—Å—Ç—å') || h.toLowerCase() === 'speed');
            const results = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim());
                if (fields.length < Math.max(nameIndex, typeIndex, statusIndex) + 1) continue;
                let yearValue = '2025';
                if (yearIndex !== -1 && fields[yearIndex]) {
                    yearValue = fields[yearIndex];
                } else if (headers.some(h => h.toLowerCase().includes('–¥–∞—Ç–∞') || h.toLowerCase() === 'date')) {
                    const dateIndex = headers.findIndex(h => h.toLowerCase().includes('–¥–∞—Ç–∞') || h.toLowerCase() === 'date');
                    if (dateIndex !== -1 && fields[dateIndex]) {
                        const dateMatch = fields[dateIndex].match(/^(\d{4})/);
                        if (dateMatch) {
                            yearValue = dateMatch[1];
                        }
                    }
                }
                let typeValue = 'game';
                if (typeIndex !== -1 && fields[typeIndex]) {
                    typeValue = normalizeType(fields[typeIndex]);
                } else {
                    if (fields[statusIndex] && (fields[statusIndex].toLowerCase().includes('—Å–ª—É—à') || fields[statusIndex].toLowerCase().includes('–ø—Ä–æ—Å–ª—É—à'))) {
                        typeValue = 'audiobook';
                    } else if (fields[statusIndex] && fields[statusIndex].toLowerCase().includes('—Å–º–æ—Ç—Ä')) {
                        typeValue = 'movie';
                    } else if (fields[statusIndex] && fields[statusIndex].toLowerCase().includes('—á–∏—Ç')) {
                        typeValue = 'story';
                    } else {
                        typeValue = 'game';
                    }
                }
                const item = {
                    id: Date.now() + i,
                    title: fields[nameIndex] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    type: typeValue,
                    status: normalizeStatus(fields[statusIndex] || 'completed'),
                    year: yearValue,
                    plays: playsIndex !== -1 ? parseInt(fields[playsIndex]) || 1 : 1,
                    tags: []
                };
                if (timeIndex !== -1 && fields[timeIndex]) {
                    item.time = fields[timeIndex];
                }
                if (seasonsIndex !== -1 && fields[seasonsIndex]) {
                    item.seasons = parseInt(fields[seasonsIndex]) || 1;
                }
                if (episodesIndex !== -1 && fields[episodesIndex]) {
                    item.episodes = parseInt(fields[episodesIndex]) || 0;
                }
                if (speedIndex !== -1 && fields[speedIndex]) {
                    item.speed = parseFloat(fields[speedIndex]) || 1.0;
                }
                if (seriesIndex !== -1 && fields[seriesIndex]) {
                    item.series = fields[seriesIndex];
                }
                if (authorIndex !== -1 && fields[authorIndex]) {
                    item.author = fields[authorIndex];
                }
                if (imageIndex !== -1 && fields[imageIndex]) {
                    item.image = fields[imageIndex];
                }
                if (tagsIndex !== -1 && fields[tagsIndex]) {
                    const tagsStr = fields[tagsIndex];
                    const cleanTags = tagsStr.replace(/^"(.*)"$/, '$1');
                    const tags = cleanTags.split(',').map(t => t.trim()).filter(t => t);
                    item.tags = tags;
                }
                results.push(item);
            }
            return results;
        }

        document.getElementById('itemYear').value = '2025';

        function openModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç';
            document.getElementById('saveButton').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
            document.getElementById('saveButton').className = 'btn btn-add';
            document.getElementById('itemType').disabled = false;
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemType').value = 'game';
            document.getElementById('itemStatus').value = 'completed';
            document.getElementById('itemYear').value = '2025';
            document.getElementById('itemPlays').value = '1';
            document.getElementById('itemImage').value = '';
            document.getElementById('itemSeries').value = '';
            document.getElementById('itemAuthor').value = '';
            document.getElementById('itemTime').value = '';
            document.getElementById('itemSeasons').value = '';
            document.getElementById('itemEpisodes').value = '0';
            document.getElementById('itemSpeed').value = '2.0';
            document.getElementById('itemTotalEpisodes').value = '';
            toggleFields();
            updateTagSelect();
            document.getElementById('addModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderCollections();
        }

        // === –û–ë–ù–û–í–õ–Å–ù–ù–´–ô –§–ò–õ–¨–¢–† –ü–û –ì–û–î–£: —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω—ã ===
        function filterByYear(collection) {
            const yearFilter = document.getElementById('yearFilter').value;
            if (yearFilter === 'all') return collection;
            const filterYearInt = parseInt(yearFilter);
            if (isNaN(filterYearInt)) return collection;
            return collection.filter(item => {
                const y = item.year;
                if (!y) return false;
                if (y === yearFilter) return true;
                const match = y.match(/^(\d{4})[-‚Äì](\d{4})$/);
                if (match) {
                    const start = parseInt(match[1]);
                    const end = parseInt(match[2]);
                    if (isNaN(start) || isNaN(end)) return false;
                    return filterYearInt >= start && filterYearInt <= end;
                }
                return false;
            });
        }

        function updateYearFilter() {
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="all">–í—Å–µ –≥–æ–¥–∞</option>';
            const years = new Set();
            collections.forEach(item => years.add(item.year));
            Array.from(years).sort((a, b) => {
                const yearA = getStartYear(a);
                const yearB = getStartYear(b);
                return yearB - yearA;
            }).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function updateGenreFilter() {
            const genreSelect = document.getElementById('genreFilter');
            genreSelect.innerHTML = '<option value="all">–í—Å–µ –∂–∞–Ω—Ä—ã</option>';
            const genres = GENRE_OPTIONS[activeTab] || GENRE_OPTIONS.all;
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre.value;
                option.textContent = genre.label;
                genreSelect.appendChild(option);
            });
        }

        function filterCollections() {
            renderCollections();
        }

        function getStatusText(status, type) {
            if (status === 'youtube' || status.toLowerCase().includes('—é—Ç—É–±') || status.toLowerCase().includes('–æ–±–∑–æ—Ä')) {
                return '–û–±–∑–æ—Ä –Ω–∞ YouTube';
            }
            if (status === 'online' || status.toLowerCase().includes('–æ–Ω–ª–∞–π–Ω')) {
                return '–û–Ω–ª–∞–π–Ω';
            }
            if (status === 'watching' || status.toLowerCase().includes('—Å–º–æ—Ç—Ä—é')) {
                return '–°–º–æ—Ç—Ä—é';
            }
            if (status === 'completed' || status.toLowerCase().includes('–∑–∞–≤–µ—Ä—à–µ–Ω–æ') || status.toLowerCase().includes('–ø—Ä–æ–π–¥–µ–Ω–æ')) {
                if (type === 'game') return '–ü—Ä–æ–π–¥–µ–Ω–æ';
                return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
            }
            if (status === 'watched' || status.toLowerCase().includes('–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ')) {
                return '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ';
            }
            if (status === 'listening' || status.toLowerCase().includes('—Å–ª—É—à–∞—é')) {
                return '–°–ª—É—à–∞—é';
            }
            if (status === 'completed_audio' || status.toLowerCase().includes('–ø—Ä–æ—Å–ª—É—à–∞–Ω–æ')) {
                return '–ü—Ä–æ—Å–ª—É—à–∞–Ω–æ';
            }
            return status;
        }

        function getImageUrl(item) {
            if (item.image && item.image.startsWith('http')) {
                return item.image;
            }
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMmQyZDQ0Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2U2ZTZlNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
        }

        function openImageModal(imageSrc) {
            if (currentView === 'grid') {
                document.getElementById('modalImage').src = imageSrc;
                document.getElementById('imageModal').classList.add('active');
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function getTagClass(tag) {
            const lowerTag = tag.toLowerCase();
            for (const [key, className] of Object.entries(TAG_COLORS)) {
                if (lowerTag.includes(key) || key.includes(lowerTag)) {
                    return className;
                }
            }
            return '';
        }

        function updateTopStats() {
            const movies = collections.filter(i => i.type === 'movie').length;
            const anime = collections.filter(i => i.type === 'anime').length;
            const series = collections.filter(i => i.type === 'series').length;
            const games = collections.filter(i => i.type === 'game').length;
            const audiobooks = collections.filter(i => i.type === 'audiobook').length;
            const stories = collections.filter(i => i.type === 'story').length;
            const movieTotalMins = collections.filter(i => i.type === 'movie').reduce((sum, m) => sum + getTotalMinutes(m), 0);
            const animeTotalMins = collections.filter(i => i.type === 'anime').reduce((sum, a) => sum + getTotalMinutes(a), 0);
            const seriesTotalMins = collections.filter(i => i.type === 'series').reduce((sum, s) => sum + getTotalMinutes(s), 0);
            const audiobookTotalMins = collections.filter(i => i.type === 'audiobook').reduce((sum, b) => sum + getTotalMinutes(b), 0);
            const storyTotalMins = collections.filter(i => i.type === 'story').reduce((sum, s) => sum + getTotalMinutes(s), 0);
            const totalMinutes = movieTotalMins + animeTotalMins + seriesTotalMins + audiobookTotalMins + storyTotalMins;
            const movieTimeStr = movieTotalMins > 0 ? `(${formatTotalTime(Math.floor(movieTotalMins / 60), movieTotalMins % 60)})` : '';
            const animeTimeStr = animeTotalMins > 0 ? `(${formatTotalTime(Math.floor(animeTotalMins / 60), animeTotalMins % 60)})` : '';
            const seriesTimeStr = seriesTotalMins > 0 ? `(${formatTotalTime(Math.floor(seriesTotalMins / 60), seriesTotalMins % 60)})` : '';
            const audiobookTimeStr = audiobookTotalMins > 0 ? `(${formatTotalTime(Math.floor(audiobookTotalMins / 60), audiobookTotalMins % 60)})` : '';
            const storyTimeStr = storyTotalMins > 0 ? `(${formatTotalTime(Math.floor(storyTotalMins / 60), storyTotalMins % 60)})` : '';
            const totalEpisodesWatched = collections.filter(i => (i.type === 'anime'|| i.type === 'series') && i.episodes).reduce((sum, i) => sum + (parseInt(i.episodes)|| 0), 0);
            const totalTimeStr = formatTotalTime(Math.floor(totalMinutes / 60), totalMinutes % 60);
            document.getElementById('statsLeft').innerHTML = `
                <div class="stat-item">üéÆ –ò–≥—Ä: ${games}</div>
                <div class="stat-item">üé¨ –§–∏–ª—å–º–æ–≤: ${movies} ${movieTimeStr}</div>
                <div class="stat-item">üì∫ –ê–Ω–∏–º–µ: ${anime} ${animeTimeStr}</div>
                <div class="stat-item">üì∫ –°–µ—Ä–∏–∞–ª–æ–≤: ${series} ${seriesTimeStr}</div>
                <div class="stat-item">üéß –ê—É–¥–∏–æ–∫–Ω–∏–≥: ${audiobooks} ${audiobookTimeStr}</div>
                <div class="stat-item">üìñ –†–∞—Å—Å–∫–∞–∑–æ–≤: ${stories} ${storyTimeStr}</div>
                <div class="stat-item" id="episodesCountTop">üéûÔ∏è –°–µ—Ä–∏–π: ${totalEpisodesWatched}</div>
                <div class="stat-item" id="timeCountTop">‚è±Ô∏è –í—Å–µ–≥–æ: ${totalTimeStr}</div>
            `;
        }

        function updateStats() {
            updateTopStats();
            const games = collections.filter(item => item.type === 'game');
            const movies = collections.filter(item => item.type === 'movie');
            const anime = collections.filter(item => item.type === 'anime');
            const series = collections.filter(item => item.type === 'series');
            const audiobooks = collections.filter(item => item.type === 'audiobook');
            const stories = collections.filter(item => item.type === 'story');
            let totalMinutes = 0;
            const movieTotalMins = movies.reduce((sum, m) => sum + getTotalMinutes(m), 0);
            const animeTotalMins = anime.reduce((sum, a) => sum + getTotalMinutes(a), 0);
            const seriesTotalMins = series.reduce((sum, s) => sum + getTotalMinutes(s), 0);
            const audiobookTotalMins = audiobooks.reduce((sum, b) => sum + getTotalMinutes(b), 0);
            const storyTotalMins = stories.reduce((sum, s) => sum + getTotalMinutes(s), 0);
            totalMinutes = movieTotalMins + animeTotalMins + seriesTotalMins + audiobookTotalMins + storyTotalMins;
            const movieTimeStr = movieTotalMins > 0 ? `(${formatTotalTime(Math.floor(movieTotalMins / 60), movieTotalMins % 60)})` : '';
            const animeTimeStr = animeTotalMins > 0 ? `(${formatTotalTime(Math.floor(animeTotalMins / 60), animeTotalMins % 60)})` : '';
            const seriesTimeStr = seriesTotalMins > 0 ? `(${formatTotalTime(Math.floor(seriesTotalMins / 60), seriesTotalMins % 60)})` : '';
            const audiobookTimeStr = audiobookTotalMins > 0 ? `(${formatTotalTime(Math.floor(audiobookTotalMins / 60), audiobookTotalMins % 60)})` : '';
            const storyTimeStr = storyTotalMins > 0 ? `(${formatTotalTime(Math.floor(storyTotalMins / 60), storyTotalMins % 60)})` : '';
            document.getElementById('statsLeft').innerHTML = `
                <div class="stat-item">üéÆ –ò–≥—Ä: ${games.length}</div>
                <div class="stat-item">üé¨ –§–∏–ª—å–º–æ–≤: ${movies.length} ${movieTimeStr}</div>
                <div class="stat-item">üì∫ –ê–Ω–∏–º–µ: ${anime.length} ${animeTimeStr}</div>
                <div class="stat-item">üì∫ –°–µ—Ä–∏–∞–ª–æ–≤: ${series.length} ${seriesTimeStr}</div>
                <div class="stat-item">üéß –ê—É–¥–∏–æ–∫–Ω–∏–≥: ${audiobooks.length} ${audiobookTimeStr}</div>
                <div class="stat-item">üìñ –†–∞—Å—Å–∫–∞–∑–æ–≤: ${stories.length} ${storyTimeStr}</div>
            `;
            document.getElementById('totalTime').innerHTML = `
                –û–±—â–µ–µ –≤—Ä–µ–º—è: ${formatTotalTime(Math.floor(totalMinutes / 60), totalMinutes % 60)}
            `;
        }

        // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: renderCollections (filterByGenre —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ) ===
        function renderCollections() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            let filtered = collections.filter(item => {
                if (activeTab === 'myshows') {
                    const isWatching = (item.type === 'anime' || item.type === 'series') && item.status === 'watching';
                    if (!isWatching) return false;
                } else if (activeTab !== 'all') {
                    if (item.type !== activeTab) return false;
                }
                const matchesSearch = item.title.toLowerCase().includes(searchTerm) ||
                                    (item.author && item.author.toLowerCase().includes(searchTerm)) ||
                                    (item.series && item.series.toLowerCase().includes(searchTerm)) ||
                                    (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                                    (item.time && item.time.toLowerCase().includes(searchTerm));
                let matchesStatus = true;
                if (activeTab !== 'myshows') {
                    matchesStatus = statusFilter === 'all' || item.status === statusFilter;
                }
                return matchesSearch && matchesStatus;
            });
            filtered = filterByYear(filtered);
            filtered = filterByLetter(filtered);
            filtered = filterByGenre(filtered); // ‚Üê —Ç–µ–ø–µ—Ä—å –Ω–µ –æ—à–∏–±–∫–∞
            filtered = sortCollection(filtered);
            if (activeTab === 'myshows') {
                renderMyShowsMode(filtered);
            } else if (currentView === 'grid') {
                renderGrid(filtered);
            } else {
                renderTable(filtered);
            }
        }

        function renderTable(filtered) {
            const grid = document.getElementById('collectionsGrid');
            const table = document.getElementById('tableView');
            const tableBody = document.getElementById('tableBody');
            grid.style.display = 'none';
            table.classList.add('active');
            if (filtered.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;"><div class="empty-state"><h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</p></div></td></tr>`;
                return;
            }
            tableBody.innerHTML = filtered.map(item => {
                const isSeries = item.series && item.type === 'audiobook';
                const isOnline = item.status === 'online' && item.type === 'game';
                const isYoutube = item.status === 'youtube' && item.type === 'game';
                let seasonsEpisodes = '-';
                if (item.type === 'anime' || item.type === 'series') {
                    const s = item.seasons || '?';
                    const e = item.episodes || 0;
                    seasonsEpisodes = `${s} / ${e}`;
                }
                let displayTime = '-';
                if (item.type === 'anime' || item.type === 'series') {
                    const totalMins = getTotalMinutes(item);
                    if (totalMins > 0) {
                        displayTime = formatTimeNicelyFromMinutes(totalMins);
                    }
                } else if (item.time) {
                    displayTime = formatTimeNicely(item.time);
                }
                const toggleBtn = item.series ? `<button class="toggle-series-btn" style="margin-left:8px; vertical-align:middle;" onclick="toggleSeries('${item.series.replace(/'/g, "\\'")}');">üìÇ</button>` : '';
                return `
                    <tr data-series="${item.series || ''}" data-id="${item.id}">
                        <td>${item.title}${item.author ? `<br><small>üë§ ${item.author}</small>` : ''}${toggleBtn}</td>
                        <td>${item.type === 'game' ? 'üéÆ –ò–≥—Ä–∞' : item.type === 'movie' ? 'üé¨ –§–∏–ª—å–º' : item.type === 'anime' ? 'üì∫ –ê–Ω–∏–º–µ' : item.type === 'series' ? 'üì∫ –°–µ—Ä–∏–∞–ª' : item.type === 'audiobook' ? 'üéß –ê—É–¥–∏–æ–∫–Ω–∏–≥–∞' : 'üìñ –†–∞—Å—Å–∫–∞–∑'}</td>
                        <td><span class="item-status ${item.status === 'completed' || item.status === 'watched' || item.status === 'completed_audio' ? 'status-completed' : item.status === 'listening' || item.status === 'reading' || item.status === 'playing' ? 'status-listening' : item.status === 'online' ? 'status-online' : item.status === 'youtube' ? 'status-youtube' : item.status === 'watching' ? 'status-watching' : ''}">${getStatusText(item.status, item.type)}</span></td>
                        <td>${item.year}</td>
                        <td>${displayTime}${item.plays > 1 ? `<br><small>üîÑ ${item.plays} —Ä–∞–∑(–∞)</small>` : ''}${(item.type === 'anime' || item.type === 'series') && item.speed && item.speed !== 1.0 ? `<br><small>‚è© ${item.speed}x</small>` : ''}</td>
                        <td>${seasonsEpisodes}</td>
                        <td>${(item.tags || []).map(tag => `<span class="tag ${getTagClass(tag)}">${tag}</span>`).join(' ')}</td>
                        <td><button class="edit-btn" onclick="openEditModal(${item.id})" style="margin-right: 5px;">‚úé</button><button class="delete-btn" onclick="deleteItem(${item.id})">√ó</button>${item.type === 'anime' || item.type === 'series' ? `<button class="add-episode-btn" onclick="addEpisode(${item.id})" style="margin-left:5px; width:24px; height:24px; font-size:14px;">+</button>` : ''}</td>
                    </tr>
                `;
            }).join('');
            applyCollapsedState();
        }

        function checkAchievements() {
            const counts = {
                movie: collections.filter(i => i.type === 'movie').length,
                anime: collections.filter(i => i.type === 'anime').length,
                series: collections.filter(i => i.type === 'series').length,
                game: collections.filter(i => i.type === 'game' && (i.status === 'completed' || i.status === 'youtube')).length,
                audiobook: collections.filter(i => i.type === 'audiobook').length
            };
            const tiers = {
                movie: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000],
                anime: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000],
                series: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000],
                game: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000],
                audiobook: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000]
            };
            const names = {
                movie: '–ö–∏–Ω–æ–º–∞–Ω',
                anime: '–ê–Ω–∏–º–µ—à–Ω–∏–∫',
                series: '–°–µ—Ä–∏–∞–ª–æ–º–∞–Ω',
                game: '–ì–µ–π–º–µ—Ä',
                audiobook: '–ê—É–¥–∏–æ—Å–ª—É—à–∞—Ç–µ–ª—å'
            };
            const icons = {
                movie: 'üé¨',
                anime: 'üì∫',
                series: 'üì∫',
                game: 'üéÆ',
                audiobook: 'üéß'
            };
            const achievements = [];
            for (const [type, thresholds] of Object.entries(tiers)) {
                let maxUnlockedLevel = 0;
                let maxUnlockedThreshold = 0;
                for (let i = thresholds.length - 1; i >= 0; i--) {
                    if (counts[type] >= thresholds[i]) {
                        maxUnlockedLevel = i + 1;
                        maxUnlockedThreshold = thresholds[i];
                        break;
                    }
                }
                if (maxUnlockedLevel > 0) {
                    let tierClass = 'bronze';
                    if (maxUnlockedLevel >= 5) tierClass = 'gold';
                    else if (maxUnlockedLevel >= 3) tierClass = 'silver';
                    achievements.push({
                        id: `${type}_${maxUnlockedLevel}`,
                        name: `${names[type]} ${maxUnlockedLevel}`,
                        desc: `${maxUnlockedThreshold}+ ${type === 'movie' ? '—Ñ–∏–ª—å–º–æ–≤' : type === 'anime' ? '–∞–Ω–∏–º–µ' : type === 'series' ? '—Å–µ—Ä–∏–∞–ª–æ–≤' : type === 'game' ? '–ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä' : '–∞—É–¥–∏–æ–∫–Ω–∏–≥'}`,
                        icon: icons[type],
                        tierClass,
                        unlocked: true
                    });
                }
            }
            const saved = JSON.parse(localStorage.getItem('unlocked_achievements') || '[]');
            const newlyUnlocked = achievements.filter(a => !saved.includes(a.id));
            if (newlyUnlocked.length > 0) {
                const allIds = [...saved, ...newlyUnlocked.map(a => a.id)];
                localStorage.setItem('unlocked_achievements', JSON.stringify(allIds));
                newlyUnlocked.forEach(a => {
                    showNotification(`üèÜ –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name}!`, 'success');
                });
            }
            return achievements;
        }

        function openAchievements() {
            const achs = checkAchievements();
            const html = achs.map(a => `<div class="achievement"><div class="ach-icon ${a.tierClass}">${a.icon}</div><div class="ach-content"><h3>${a.name}</h3><p>${a.desc}</p></div></div>`).join('');
            document.getElementById('collectionsGrid').innerHTML = `<h2 style="margin-bottom: 20px; color: #4fc3f7; text-align: center;">üèÜ –ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>${achs.length ? `<div class="achievements-grid">${html}</div>` : '<p style="text-align:center; color:#a0a0c0;">–ù–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>'}`;
            document.getElementById('tableView').classList.remove('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        }

        function renderMyShowsMode(filtered) {
            const grid = document.getElementById('collectionsGrid');
            const table = document.getElementById('tableView');
            grid.style.display = 'block';
            table.classList.remove('active');
            const watchingItems = filtered.filter(item => (item.type === 'anime' || item.type === 'series') && item.status === 'watching');
            if (watchingItems.length === 0) {
                grid.innerHTML = `<div class="empty-state"><h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–∏–∞–ª –∏–ª–∏ –∞–Ω–∏–º–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–°–º–æ—Ç—Ä—é¬ª</p></div>`;
                return;
            }
            grid.className = 'myshows-list';
            grid.innerHTML = watchingItems.map(item => {
                const total = item.totalEpisodes || '?';
                const watched = item.episodes || 0;
                const poster = getImageUrl(item);
                const progress = total !== '?' ? `${watched}/${total}` : `${watched} —Å–µ—Ä–∏–π`;
                return `<div class="myshow-item" data-id="${item.id}"><div class="myshow-header" onclick="toggleSeasons(${item.id})"><img src="${poster}" class="myshow-poster" alt="${item.title}"><div class="myshow-info"><div class="myshow-title">${item.title}</div><div class="myshow-meta"><span>üìÖ ${item.year}</span><span>‚è±Ô∏è ${formatTimeNicelyFromMinutes(getTotalMinutes(item))}</span><span>‚è© ${item.speed || 1.0}x</span></div></div><div class="myshow-actions"><span class="episode-progress">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${progress}</span><button class="toggle-seasons-btn">‚ñº</button></div></div><div class="seasons-container" id="seasons-${item.id}"><div class="season-row"><span class="season-info">–°–µ–∑–æ–Ω ${item.seasons || 1}</span><div style="display:flex;align-items:center;gap:8px;"><span class="episode-progress">${progress}</span><button class="add-ep-btn" onclick="event.stopPropagation(); addEpisode(${item.id});">+</button></div></div></div></div>`;
            }).join('');
        }

        function toggleSeasons(id) {
            const container = document.getElementById(`seasons-${id}`);
            if (container.style.display === 'block') {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
            }
        }

        function renderFranchisesByType() {
            const grid = document.getElementById('collectionsGrid');
            grid.style.display = 'block';
            document.getElementById('tableView').classList.remove('active');
            const types = [
                { key: 'game', label: '–ò–≥—Ä—ã', icon: 'üéÆ' },
                { key: 'movie', label: '–§–∏–ª—å–º—ã', icon: 'üé¨' },
                { key: 'anime', label: '–ê–Ω–∏–º–µ', icon: 'üì∫' },
                { key: 'series', label: '–°–µ—Ä–∏–∞–ª—ã', icon: 'üì∫' },
                { key: 'audiobook', label: '–ê—É–¥–∏–æ–∫–Ω–∏–≥–∏', icon: 'üéß' },
                { key: 'story', label: '–†–∞—Å—Å–∫–∞–∑—ã', icon: 'üìñ' }
            ];
            const typeMap = {};
            collections.forEach(item => {
                if (!item.series) return;
                if (!typeMap[item.type]) typeMap[item.type] = {};
                const franchise = typeMap[item.type][item.series] = typeMap[item.type][item.series] || {
                    name: item.series,
                    count: 0,
                    years: [],
                    totalSeasons: 0,
                    totalEpisodes: 0,
                    totalMinutes: 0,
                    completedCount: 0,
                    statuses: new Set()
                };
                franchise.count++;
                if (item.year) franchise.years.push(getStartYear(item.year)); // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                if (item.status) franchise.statuses.add(item.status);
                if ((item.type === 'anime' || item.type === 'series') && item.status === 'watched' && item.seasons) {
                    franchise.totalSeasons += item.seasons || 0;
                }
                if (item.type === 'anime' || item.type === 'series') {
                    franchise.totalEpisodes += item.episodes || 0;
                }
                const mins = getTotalMinutes(item);
                franchise.totalMinutes += mins;
                if (['completed', 'watched', 'completed_audio'].includes(item.status)) {
                    franchise.completedCount++;
                }
            });
            let html = '';
            types.forEach(type => {
                const franchises = typeMap[type.key];
                if (!franchises) return;
                const franchiseList = Object.values(franchises);
                if (franchiseList.length === 0) return;
                franchiseList.sort((a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    return a.name.localeCompare(b.name, 'ru');
                });
                html += `<div class="franchise-section"><h3>${type.icon} ${type.label}</h3><div class="franchise-list">${franchiseList.map(f => {
                    const uniqueYears = [...new Set(f.years)].sort((x, y) => x - y);
                    const yearRange = uniqueYears.length > 1
                        ? `${uniqueYears[0]}‚Äì${uniqueYears[uniqueYears.length - 1]}`
                        : uniqueYears[0] || '';
                    let details = [];
                    if (type.key === 'game') {
                        details.push(`${f.count} –∏–≥—Ä`);
                        if (f.completedCount > 0 && f.completedCount < f.count) {
                            details.push(`${f.completedCount} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
                        }
                    } else if (type.key === 'anime' || type.key === 'series') {
                        details.push(`${f.count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                        if (f.totalSeasons > 0) details.push(`${f.totalSeasons} —Å–µ–∑–æ–Ω–æ–≤`);
                        if (f.totalEpisodes > 0) details.push(`${f.totalEpisodes} —Å–µ—Ä–∏–π`);
                    } else if (type.key === 'audiobook' || type.key === 'story') {
                        details.push(`${f.count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                    }
                    if (f.totalMinutes > 0) {
                        details.push(`${formatTimeNicelyFromMinutes(f.totalMinutes)}`);
                    }
                    return `<div class="franchise-item" onclick="showFranchiseItems('${type.key}', '${f.name.replace(/'/g, "\\'")}')"><div class="franchise-title">${f.name}</div><div class="franchise-meta">${details.join(' ‚Ä¢ ')}${yearRange ? ` ‚Ä¢ ${yearRange}` : ''}</div></div>`;
                }).join('')}</div></div>`;
            });
            if (!html) {
                html = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>–ù–µ—Ç —Ñ—Ä–∞–Ω—à–∏–∑</h3><p>–î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å–µ—Ä–∏–∏/—Ñ—Ä–∞–Ω—à–∏–∑—ã</p></div>`;
            }
            grid.innerHTML = html;
        }

        function showFranchiseItems(type, seriesName) {
            const filtered = collections.filter(item => item.type === type && item.series === seriesName);
            activeTab = 'all';
            localStorage.setItem(TAB_KEY, 'all');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab').classList.add('active');
            document.querySelector('.header-title h1').textContent = `–§—Ä–∞–Ω—à–∏–∑–∞: ${seriesName}`;
            if (currentView === 'grid') {
                renderGrid(filtered);
            } else {
                renderTable(filtered);
            }
        }

        // === –ó–ê–ü–£–°–ö ===
        loadCollection();
        const savedTab = localStorage.getItem(TAB_KEY);
        if (savedTab) {
            activeTab = savedTab;
            document.querySelectorAll('.tab').forEach(tab => {
                const text = tab.textContent.trim().toLowerCase();
                let match = false;
                if (savedTab === 'all' && text.includes('–≤—Å–µ')) match = true;
                else if (savedTab === 'game' && text.includes('–∏–≥—Ä—ã')) match = true;
                else if (savedTab === 'movie' && text.includes('—Ñ–∏–ª—å–º—ã')) match = true;
                else if (savedTab === 'anime' && text.includes('–∞–Ω–∏–º–µ')) match = true;
                else if (savedTab === 'series' && text.includes('—Å–µ—Ä–∏–∞–ª—ã')) match = true;
                else if (savedTab === 'audiobook' && text.includes('–∞—É–¥–∏–æ–∫–Ω–∏–≥–∏')) match = true;
                else if (savedTab === 'story' && text.includes('—Ä–∞—Å—Å–∫–∞–∑—ã')) match = true;
                else if (savedTab === 'watching' && text.includes('—Å–º–æ—Ç—Ä—é')) match = true;
                else if (savedTab === 'myshows' && text.includes('myshows')) match = true;
                else if (savedTab === 'franchises' && text.includes('—Ñ—Ä–∞–Ω—à–∏–∑—ã')) match = true;
                else if (savedTab === 'stats' && text.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')) match = true;
                tab.classList.toggle('active', match);
            });
        }
        if (savedTab === 'franchises') {
            document.querySelector('.header-title h1').textContent = 'üß© –§—Ä–∞–Ω—à–∏–∑—ã';
            document.querySelector('.search-container').style.display = 'none';
            renderFranchisesByType();
        } else if (savedTab === 'stats') {
            document.querySelector('.search-container').style.display = 'block';
            renderStats();
        } else if (savedTab === 'myshows') {
            document.querySelector('.search-container').style.display = 'block';
            const watchingItems = collections.filter(item => (item.type === 'anime' || item.type === 'series') && item.status === 'watching');
            renderMyShowsMode(watchingItems);
        } else {
            document.querySelector('.header-title h1').textContent = '–ú–æ—è –ö–æ–ª–ª–µ–∫—Ü–∏—è';
            document.querySelector('.search-container').style.display = 'block';
            renderCollections();
        }
        updateStats();
        updateYearFilter();
        updateGenreFilter();
    </script>
</body>
</html>